#!/usr/bin/env bash

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
export BUILDPACK_PATH=$BP_DIR
source $BP_DIR/compile-extensions/lib/common
export R_HOME="/app/lib/R"

mkdir -p "$BUILD_DIR/.profile.d"
cat << EOF > "${BUILD_DIR}/.profile.d/0000_set_R_path.sh"
PATH="\$PATH:/app/bin"
R_HOME="/app"
LD_LIBRARY_PATH="\$LD_LIBRARY_PATH:/app/lib/R/lib:/app/lib/R/library/rJava/libs:/app/lib/R/library/rJava/libs"
EOF

chmod +x "${BUILD_DIR}/.profile.d/0000_set_R_path.sh"

$BP_DIR/compile-extensions/bin/download_dependency_by_name r-binary 3.4.2 ${BUILD_DIR}/R.tar.gz
cd $BUILD_DIR
tar -zxf R.tar.gz
rm R.tar.gz

if [ -d "$BUILD_DIR/BOOT-INF" ]; then
    cp $BUILD_DIR/lib/R/library/rJava/jri/*.jar $BUILD_DIR/BOOT-INF/lib/
fi

cat << EOF > $DEPS_DIR/$DEPS_IDX/config.yml
name: r-buildpack
config:
  environment_variables:
    R_HOME: "/app/lib/R"
    LD_LIBRARY_PATH: "/app/lib:/app/bin:"
EOF

$BP_DIR/compile-extensions/bin/check_buildpack_version $BP_DIR $CACHE_DIR
$BP_DIR/compile-extensions/bin/write_config_yml $BP_DIR "$DEPS_DIR/$DEPS_IDX"

exit 0
